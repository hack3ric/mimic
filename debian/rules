#!/usr/bin/make -f

include /usr/share/dpkg/default.mk

export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_VERSION_UPSTREAM

IS_UBUNTU := $(shell dpkg-vendor --derives-from ubuntu > /dev/null 2>&1; echo $$?)

njobs = 1
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
njobs = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
endif

%:
	dh $@

override_dh_auto_configure:
	sed install/mimic@.service.in \
		-e 's|@@MIMIC_EXEC@@|/usr/sbin/mimic|' \
		-e 's|@@MIMIC_CONFIG_PATH@@|/etc/mimic|' \
		-e 's|@@MIMIC_RUNTIME_DIR@@|mimic|' \
		> debian/mimic@.service
	sed kmod/dkms.conf.in \
		-e 's|@@EXTRA_OPTS@@|CHECKSUM_HACK=kfunc|' \
		> kmod/dkms.conf
	cp install/mimic.sysusers debian/mimic.sysusers

override_dh_auto_build:
	tar xf `bash -c '_tarballs=(/usr/src/linux-source-*.tar.*); echo $${_tarballs[0]}'`
ifeq ($(IS_UBUNTU),0)
#	Ubuntu's bpftool relies on current kernel, which is both inconsistent
#	with Debian and sbuild-unfriendly. Build from kernel source instead.
	make -j$(njobs) -C linux-source-*/tools/bpf/bpftool
	dh_auto_build -- build-cli build-tools generate-manpage \
		MODE= \
		BPF_CC=clang \
		USE_LIBXDP=1 \
		BPFTOOL=linux-source-*/tools/bpf/bpftool/bpftool
else
	dh_auto_build -- build-cli build-tools generate-manpage \
		MODE= \
		BPF_CC=clang \
		USE_LIBXDP=1
endif
	@HOST_ARCH=$$(uname -m); \
	HOST_LIB_DIR="/usr/lib/$${HOST_ARCH}-linux-gnu"; \
	if [ ! -d "$$HOST_LIB_DIR" ]; then \
		HOST_LIB_DIR="/usr/lib64"; \
	fi; \
	echo "Building resolve_btfids with HOST_ARCH=$$HOST_ARCH, LIB_DIR=$$HOST_LIB_DIR"; \
	for mkfile in linux-source-*/tools/bpf/resolve_btfids/Makefile; do \
		if [ -f "$$mkfile" ]; then \
			perl -i -pe "s|^(.*resolve_btfids.*)\$\$|\1 -L$$HOST_LIB_DIR -L/usr/lib64 -lelf -lz|" "$$mkfile"; \
			if ! grep -q "HOSTLDFLAGS.*-lelf" "$$mkfile"; then \
				echo "HOSTLDFLAGS += -L$$HOST_LIB_DIR -L/usr/lib64 -lelf -lz" >> "$$mkfile"; \
			fi; \
		fi; \
	done; \
	PKG_CONFIG_PATH="$$HOST_LIB_DIR/pkgconfig:/usr/lib/pkgconfig" \
	LIBELF_LIBS="-lelf" ZLIB_LIBS="-lz" \
	HOSTLDFLAGS="-L$$HOST_LIB_DIR -L/usr/lib64 -lelf -lz" \
	LDFLAGS="-L$$HOST_LIB_DIR -L/usr/lib64 -lelf -lz" \
	make -j$(njobs) -C linux-source-*/tools/bpf/resolve_btfids

override_dh_auto_test:

override_dh_dkms:
	dh_dkms -pmimic-dkms -V$(DEB_VERSION_UPSTREAM)

override_dh_auto_clean:
	dh_auto_clean
	rm -rf linux-source-*
	rm -f debian/mimic@.service debian/mimic.sysusers
